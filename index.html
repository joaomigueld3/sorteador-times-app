<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sorteador de Times</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fonte Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar para √°reas internas */
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Remover setas input number */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Drag and Drop */
        .draggable-player {
            cursor: grab;
            transition: transform 0.1s, box-shadow 0.1s, background-color 0.15s;
        }
        .draggable-player:active {
            cursor: grabbing;
        }
        .draggable-player.dragging {
            opacity: 0.6;
            background-color: #f3f4f6;
            transform: scale(0.98);
            border: 1px dashed #3b82f6;
        }
        .team-drop-zone {
            transition: background-color 0.2s, border-color 0.2s;
        }
        .team-drop-zone.drag-over {
            background-color: #eff6ff;
            border-color: #60a5fa;
            border-style: dashed;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 h-screen w-screen flex flex-col overflow-hidden selection:bg-blue-100 selection:text-blue-900">

    <!-- Header Fixo -->
    <header class="bg-white border-b border-gray-200 px-4 py-2 shrink-0 flex justify-between items-center shadow-sm z-20 h-14">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600 text-white p-1.5 rounded-lg shadow-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            </div>
            <h1 class="text-lg font-bold text-gray-800 tracking-tight leading-none">Sorteador<br><span class="text-blue-600 text-xs font-medium uppercase tracking-wider">de Times</span></h1>
        </div>
        <div class="flex items-center gap-3">
             <button id="clear-all-btn" class="text-xs text-red-500 hover:text-red-700 font-medium hover:underline">Limpar Tudo</button>
        </div>
    </header>

    <!-- Main Content -->
    <!-- min-h-0 √© crucial aqui para permitir que os filhos tenham scroll interno -->
    <main class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-4 p-4 min-h-0 overflow-hidden">

        <!-- Coluna da Esquerda (Formul√°rios) -->
        <div class="lg:col-span-4 flex flex-col gap-3 h-full min-h-0 overflow-y-auto custom-scrollbar pr-1">
            
            <!-- Card de Sorteio (Movi para cima para acesso r√°pido) -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 shrink-0">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-bold text-gray-700 uppercase tracking-wide">Sortear</h2>
                    <div class="flex items-center gap-2 bg-gray-50 p-1 rounded-md border border-gray-200">
                        <label for="num-teams" class="text-xs font-medium text-gray-500 pl-1">Times:</label>
                        <input type="number" id="num-teams" min="2" value="2" class="w-10 text-center text-sm bg-transparent border-none p-0 focus:ring-0 font-bold text-gray-800">
                    </div>
                </div>
                
                <form id="draw-teams-form">
                    <button type="submit" class="w-full bg-green-600 text-white py-2.5 px-4 rounded-lg text-sm font-bold hover:bg-green-700 active:bg-green-800 transition-all shadow-sm flex justify-center items-center gap-2 transform hover:-translate-y-0.5">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        GERAR TIMES
                    </button>
                </form>
            </div>

            <!-- Card de Cadastro -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-col gap-3">
                <div class="flex justify-between items-center border-b border-gray-100 pb-2">
                    <h2 class="text-sm font-bold text-gray-700 uppercase tracking-wide">Novo Jogador</h2>
                    <div class="flex bg-gray-100 p-0.5 rounded-lg text-[10px] font-semibold">
                        <button id="tab-single" class="px-2 py-1 rounded bg-white text-blue-600 shadow-sm transition-all">Individual</button>
                        <button id="tab-bulk" class="px-2 py-1 rounded text-gray-500 hover:text-gray-700 transition-all">Lote</button>
                    </div>
                </div>

                <!-- Formul√°rio Individual -->
                <form id="add-player-form" class="space-y-3">
                    <input type="text" id="name" placeholder="Nome do Jogador" required class="block w-full text-sm rounded-lg border-gray-200 bg-gray-50 p-2.5 focus:border-blue-500 focus:ring-blue-500 outline-none transition-shadow">
                    
                    <div class="grid grid-cols-3 gap-2">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">F√≠sico</label>
                            <input type="number" id="fisico" placeholder="0-10" min="0" max="10" step="0.5" required class="block w-full text-sm rounded-lg border-gray-200 bg-gray-50 p-2 text-center focus:border-blue-500 focus:ring-blue-500 outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Habil.</label>
                            <input type="number" id="habilidade" placeholder="0-10" min="0" max="10" step="0.5" required class="block w-full text-sm rounded-lg border-gray-200 bg-gray-50 p-2 text-center focus:border-blue-500 focus:ring-blue-500 outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Defesa</label>
                            <input type="number" id="defesa" placeholder="0-10" min="0" max="10" step="0.5" required class="block w-full text-sm rounded-lg border-gray-200 bg-gray-50 p-2 text-center focus:border-blue-500 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors shadow-sm flex justify-center items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        Adicionar
                    </button>
                </form>

                <!-- Formul√°rio Em Lote -->
                <form id="bulk-player-form" class="space-y-3 hidden">
                    <div class="relative">
                        <textarea id="bulk-input" rows="6" class="block w-full p-3 text-xs rounded-lg border-gray-200 bg-gray-50 focus:border-blue-500 focus:ring-blue-500 font-mono resize-none leading-relaxed" placeholder="Pedro, 8&#10;Lucas, 6.5&#10;Jo√£o, 8, 7, 6"></textarea>
                        <div class="absolute bottom-2 right-2 text-[9px] text-gray-400 bg-white/80 px-1 rounded backdrop-blur-sm pointer-events-none">
                            "Nome, Nota" ou "Nome, F, H, D"
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors shadow-sm">
                        Importar Lista
                    </button>
                </form>
            </div>
        </div>

        <!-- Coluna da Direita (Lista de Jogadores) -->
        <!-- Flex-col e min-h-0 permitem que o container ocupe a altura restante sem estourar -->
        <div class="lg:col-span-8 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col min-h-0 h-full overflow-hidden">
            <div class="p-3 border-b border-gray-100 flex justify-between items-center bg-gray-50/80 shrink-0">
                <div class="flex items-center gap-2">
                    <h2 class="text-sm font-bold text-gray-700 uppercase tracking-wide">Jogadores Presentes</h2>
                    <span id="player-count" class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-0.5 rounded-full border border-blue-200 min-w-[24px] text-center">0</span>
                </div>
                <div class="flex items-center gap-2 text-xs">
                    <label class="flex items-center gap-1.5 cursor-pointer text-gray-600 hover:text-blue-600 select-none">
                        <input type="checkbox" id="select-all-checkbox" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 h-3.5 w-3.5">
                        Todos
                    </label>
                </div>
            </div>
            
            <!-- Lista com scroll interno independente -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-3 bg-white relative">
                <div id="empty-list-message" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 pointer-events-none">
                    <svg class="w-12 h-12 mb-2 text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <p class="text-sm font-medium">Lista vazia</p>
                    <p class="text-xs opacity-75">Cadastre jogadores ao lado</p>
                </div>
                
                <div id="player-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                    <!-- Items injetados via JS -->
                </div>
            </div>
        </div>

    </main>

    <!-- Modal de Resultados -->
    <div id="results-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden backdrop-blur-sm bg-gray-900/40">
        <!-- max-h-[95vh] garante que o modal n√£o estoure a tela verticalmente -->
        <div class="bg-white w-full max-w-6xl rounded-2xl shadow-2xl overflow-hidden transform transition-all max-h-[95vh] h-full flex flex-col border border-gray-200">
            <!-- Header Modal -->
            <div class="flex justify-between items-center px-5 py-3 border-b bg-gray-50/80 shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-green-100 text-green-700 p-1.5 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-gray-800 leading-tight">Times Definidos</h2>
                        <p class="text-[10px] text-gray-500 uppercase tracking-wider font-semibold">Arraste para ajustar</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <button id="reshuffle-btn" class="flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 text-blue-600 border border-blue-100 rounded-lg hover:bg-blue-100 hover:border-blue-200 transition-all text-xs font-bold uppercase tracking-wide">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        Resortear
                    </button>
                    <button id="copy-whatsapp-btn" class="flex items-center gap-1.5 px-3 py-1.5 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all text-xs font-bold uppercase tracking-wide shadow-sm transform active:scale-95">
                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                        WhatsApp
                    </button>
                    <button id="close-modal-btn" class="ml-2 text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>
            
            <!-- Container dos Times (Scroll√°vel) -->
            <div id="teams-container" class="p-4 overflow-y-auto overflow-x-hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 flex-grow bg-gray-50 custom-scrollbar">
                <!-- Times ser√£o injetados aqui -->
            </div>

            <!-- √Årea de Texto para Copiar (Compacta) -->
            <div class="p-3 bg-white border-t border-gray-200 shrink-0">
                <div class="relative">
                     <textarea id="share-textarea" readonly class="w-full h-12 py-2 pl-3 pr-20 text-[11px] font-mono border border-gray-200 rounded-lg bg-gray-50 text-gray-500 focus:outline-none resize-none" onclick="this.select()"></textarea>
                     <div class="absolute top-0 bottom-0 right-0 flex items-center pr-2">
                        <span class="text-[10px] font-bold text-gray-300 uppercase tracking-widest pointer-events-none">Copiar</span>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const addPlayerForm = document.getElementById('add-player-form');
            const bulkPlayerForm = document.getElementById('bulk-player-form');
            const playerList = document.getElementById('player-list');
            const emptyListMessage = document.getElementById('empty-list-message');
            const drawTeamsForm = document.getElementById('draw-teams-form');
            const modal = document.getElementById('results-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const reshuffleBtn = document.getElementById('reshuffle-btn');
            const copyWhatsappBtn = document.getElementById('copy-whatsapp-btn');
            const teamsContainer = document.getElementById('teams-container');
            const shareTextarea = document.getElementById('share-textarea');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const clearAllBtn = document.getElementById('clear-all-btn');

            // Tabs
            const tabSingle = document.getElementById('tab-single');
            const tabBulk = document.getElementById('tab-bulk');

            // --- Estado da Aplica√ß√£o ---
            let state = {
                players: []
            };

            let currentTeamsState = [];
            const DB_KEY = 'sorteio_times_players';

            // --- Fun√ß√µes Auxiliares ---
            function loadPlayersFromDB() {
                const playersFromDB = localStorage.getItem(DB_KEY);
                state.players = playersFromDB ? JSON.parse(playersFromDB) : [];
            }

            function savePlayersToDB() {
                localStorage.setItem(DB_KEY, JSON.stringify(state.players));
            }

            function addPlayer(name, fisico, habilidade, defesa) {
                const newPlayer = {
                    id: crypto.randomUUID(),
                    name,
                    attributes: {
                        fisico: parseFloat(fisico),
                        habilidade: parseFloat(habilidade),
                        defesa: parseFloat(defesa)
                    }
                };
                state.players.push(newPlayer);
                savePlayersToDB();
                renderPlayerList();
            }

            function deletePlayer(id) {
                state.players = state.players.filter(player => player.id !== id);
                savePlayersToDB();
                renderPlayerList();
            }

            // --- Renderiza√ß√£o ---
            function renderPlayerList() {
                playerList.innerHTML = ''; 

                const countEl = document.getElementById('player-count');
                if (countEl) countEl.textContent = state.players.length;

                if (state.players.length === 0) {
                    emptyListMessage.classList.remove('hidden');
                    return;
                }
                
                emptyListMessage.classList.add('hidden');
                const sortedPlayers = [...state.players].sort((a, b) => a.name.localeCompare(b.name));

                sortedPlayers.forEach(player => {
                    const overall = (player.attributes.fisico + player.attributes.habilidade + player.attributes.defesa) / 3;

                    const playerEl = document.createElement('div');
                    playerEl.className = 'flex items-center justify-between p-2 pl-3 bg-white rounded-lg border border-gray-100 shadow-sm hover:shadow-md transition-all group hover:border-blue-200';
                    
                    playerEl.innerHTML = `
                        <div class="flex items-center gap-3 min-w-0 flex-1">
                            <input type="checkbox" data-player-id="${player.id}" checked class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 player-checkbox cursor-pointer transition-colors">
                            <div class="truncate flex-1">
                                <div class="font-semibold text-gray-800 text-sm truncate" title="${player.name}">${player.name}</div>
                                <div class="flex items-center gap-2 mt-0.5">
                                    <span class="text-[10px] font-bold text-blue-700 bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100">${overall.toFixed(1)}</span>
                                    <span class="text-[10px] text-gray-400 font-mono tracking-tighter">F:${player.attributes.fisico} H:${player.attributes.habilidade} D:${player.attributes.defesa}</span>
                                </div>
                            </div>
                        </div>
                        <button data-delete-id="${player.id}" class="text-gray-300 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100 transition-all rounded-full hover:bg-red-50">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    `;
                    playerList.appendChild(playerEl);
                });
            }

            // --- L√≥gica Sorteio (Corre√ß√£o Resortear) ---
            function handleDrawTeams(e) {
                if(e) e.preventDefault();

                const presentPlayerCheckboxes = document.querySelectorAll('.player-checkbox:checked');
                const presentPlayerIds = Array.from(presentPlayerCheckboxes).map(cb => cb.dataset.playerId);

                if (presentPlayerIds.length === 0) return alert('Selecione pelo menos um jogador.');

                const numTeams = parseInt(document.getElementById('num-teams').value);
                if (isNaN(numTeams) || numTeams < 2) return alert('Times inv√°lidos.');
                if (presentPlayerIds.length < numTeams) return alert('Jogadores insuficientes.');

                // Mapeia jogadores
                const playersToDraw = state.players
                    .filter(player => presentPlayerIds.includes(player.id))
                    .map(player => {
                        const overall = (player.attributes.fisico + player.attributes.habilidade + player.attributes.defesa) / 3;
                        return { ...player, overall };
                    });

                // CORRE√á√ÉO: Adiciona aleatoriedade ao Resortear
                // 1. Adiciona um "jitter" (ru√≠do) min√∫sculo √† nota para quebrar empates de forma aleat√≥ria
                //    Isso faz com que jogadores iguais troquem de lugar.
                playersToDraw.forEach(p => {
                    p.tempSortValue = p.overall + (Math.random() * 0.05); 
                });

                // 2. Ordena pela nota com ru√≠do
                playersToDraw.sort((a, b) => b.tempSortValue - a.tempSortValue);

                // Inicializa times
                let teams = Array.from({ length: numTeams }, () => []);
                
                // Helper totais (usa o overall real, n√£o o tempor√°rio)
                const getTeamStats = (team) => {
                    if (team.length === 0) return { overall: 0 };
                    return team.reduce((acc, p) => ({ overall: acc.overall + p.overall }), { overall: 0 });
                };

                // Algoritmo Guloso Balanceado
                for (const player of playersToDraw) {
                    let bestTeamIndex = -1;
                    let lowestScore = Infinity;

                    // Encontra o time mais fraco/vazio para colocar o pr√≥ximo craque
                    for (let i = 0; i < teams.length; i++) {
                        const stats = getTeamStats(teams[i]);
                        let score = stats.overall;
                        // Penalidade alta para times com mais jogadores (garante x jogadores em cada time antes de por x+1)
                        score += (teams[i].length * 1000); 

                        if (score < lowestScore) {
                            lowestScore = score;
                            bestTeamIndex = i;
                        }
                    }
                    teams[bestTeamIndex].push(player);
                }

                // Salva estado e renderiza
                currentTeamsState = teams;
                renderResultsModal();
            }

            function calculateTeamAverages(team) {
                if (team.length === 0) return { overall: 0, fisico: 0, habilidade: 0, defesa: 0, count: 0 };
                const sum = team.reduce((acc, p) => ({
                    overall: acc.overall + p.overall,
                    fisico: acc.fisico + p.attributes.fisico,
                    habilidade: acc.habilidade + p.attributes.habilidade,
                    defesa: acc.defesa + p.attributes.defesa
                }), { overall: 0, fisico: 0, habilidade: 0, defesa: 0 });
                
                const count = team.length;
                return {
                    count,
                    overall: sum.overall / count,
                    fisico: sum.fisico / count,
                    habilidade: sum.habilidade / count,
                    defesa: sum.defesa / count
                };
            }

            function generateShareText() {
                let text = `‚öΩ *Sorteio de Times* ‚öΩ\n\n`;
                currentTeamsState.forEach((team, index) => {
                    // Ordena√ß√£o visual por nota real
                    const sortedTeam = [...team].sort((a, b) => b.overall - a.overall);
                    const stats = calculateTeamAverages(sortedTeam);
                    const icon = index % 2 === 0 ? 'üîµ' : 'üî¥';
                    text += `${icon} *Time ${index + 1}* (M√©dia: ${stats.overall.toFixed(1)})\n`;
                    sortedTeam.forEach(player => {
                        text += `‚ñ´Ô∏è ${player.name} (${player.overall.toFixed(1)})\n`;
                    });
                    text += `\n`;
                });
                text += `_Gerado pelo Sorteador de Times_`;
                return text;
            }

            function renderResultsModal() {
                teamsContainer.innerHTML = ''; 
                const shareText = generateShareText();
                shareTextarea.value = shareText;

                currentTeamsState.forEach((team, index) => {
                    // Garante que visualmente sempre est√° ordenado
                    team.sort((a, b) => b.overall - a.overall);
                    const stats = calculateTeamAverages(team);
                    
                    const teamCard = document.createElement('div');
                    teamCard.className = 'bg-white border border-gray-200 rounded-xl overflow-hidden flex flex-col h-full shadow-sm hover:shadow-md transition-shadow';
                    
                    teamCard.innerHTML = `
                        <div class="p-3 bg-gray-50 border-b border-gray-100 shrink-0">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-sm font-black text-gray-700 uppercase tracking-wider">Time ${index + 1}</h3>
                                <span class="bg-white text-gray-600 text-[10px] font-bold px-2 py-0.5 rounded border border-gray-200 shadow-sm">${stats.count} Jog.</span>
                            </div>
                            <div class="grid grid-cols-4 gap-1 text-center text-[10px] text-gray-500">
                                <div class="bg-blue-50 rounded p-1 border border-blue-100">
                                    <span class="block font-bold text-blue-700 text-xs">${stats.overall.toFixed(1)}</span>
                                    <span class="text-[9px] uppercase">Geral</span>
                                </div>
                                <div class="bg-white rounded p-1 border border-gray-100"><span class="block font-bold text-gray-800">${stats.fisico.toFixed(1)}</span>Fis</div>
                                <div class="bg-white rounded p-1 border border-gray-100"><span class="block font-bold text-gray-800">${stats.habilidade.toFixed(1)}</span>Hab</div>
                                <div class="bg-white rounded p-1 border border-gray-100"><span class="block font-bold text-gray-800">${stats.defesa.toFixed(1)}</span>Def</div>
                            </div>
                        </div>
                    `;

                    const playerListEl = document.createElement('ul');
                    playerListEl.className = 'team-drop-zone p-2 flex-grow overflow-y-auto min-h-[100px] bg-white space-y-1';
                    playerListEl.dataset.teamIndex = index;

                    playerListEl.addEventListener('dragover', handleDragOver);
                    playerListEl.addEventListener('dragleave', handleDragLeave);
                    playerListEl.addEventListener('drop', handleDrop);

                    team.forEach(player => {
                        const li = document.createElement('li');
                        li.className = 'draggable-player py-1.5 px-2 bg-white border border-gray-100 rounded-lg flex justify-between items-center shadow-sm select-none';
                        li.draggable = true; 
                        li.dataset.playerId = player.id;
                        li.dataset.originTeam = index;

                        li.innerHTML = `
                            <div class="flex items-center gap-2 overflow-hidden">
                                <div class="w-1 h-5 bg-gray-200 rounded-full cursor-move hover:bg-gray-400 transition-colors"></div>
                                <div class="truncate">
                                    <span class="text-gray-800 font-semibold text-xs block truncate">${player.name}</span>
                                </div>
                            </div>
                            <span class="text-[10px] font-bold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded ml-2">${player.overall.toFixed(1)}</span>
                        `;
                        li.addEventListener('dragstart', handleDragStart);
                        li.addEventListener('dragend', handleDragEnd);
                        playerListEl.appendChild(li);
                    });

                    teamCard.appendChild(playerListEl);
                    teamsContainer.appendChild(teamCard);
                });

                modal.classList.remove('hidden');
            }

            // --- Handlers Bot√µes ---
            copyWhatsappBtn.addEventListener('click', () => {
                const text = generateShareText();
                navigator.clipboard.writeText(text).then(() => {
                    const originalHTML = copyWhatsappBtn.innerHTML;
                    copyWhatsappBtn.innerHTML = `Copiado!`;
                    copyWhatsappBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    copyWhatsappBtn.classList.add('bg-green-700');
                    setTimeout(() => {
                        copyWhatsappBtn.innerHTML = originalHTML;
                        copyWhatsappBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                        copyWhatsappBtn.classList.remove('bg-green-700');
                    }, 1500);
                }).catch(() => {
                    shareTextarea.select();
                    alert('Copie manualmente da caixa de texto abaixo.');
                });
            });

            // --- Drag & Drop ---
            let draggedItem = null;
            let sourceTeamIndex = null;

            function handleDragStart(e) {
                draggedItem = this;
                sourceTeamIndex = parseInt(this.dataset.originTeam);
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', this.dataset.playerId);
            }

            function handleDragEnd(e) {
                this.classList.remove('dragging');
                draggedItem = null;
                sourceTeamIndex = null;
                document.querySelectorAll('.team-drop-zone').forEach(zone => zone.classList.remove('drag-over'));
            }

            function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; this.classList.add('drag-over'); }
            function handleDragLeave(e) { this.classList.remove('drag-over'); }

            function handleDrop(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                const targetTeamIndex = parseInt(this.dataset.teamIndex);
                if (sourceTeamIndex === targetTeamIndex) return;

                const playerId = e.dataTransfer.getData('text/plain');
                const playerIndex = currentTeamsState[sourceTeamIndex].findIndex(p => p.id === playerId);
                if (playerIndex === -1) return;

                const [playerMoved] = currentTeamsState[sourceTeamIndex].splice(playerIndex, 1);
                currentTeamsState[targetTeamIndex].push(playerMoved);
                
                renderResultsModal();
            }

            // --- UI Interaction ---
            tabSingle.addEventListener('click', (e) => {
                e.preventDefault();
                addPlayerForm.classList.remove('hidden');
                bulkPlayerForm.classList.add('hidden');
                tabSingle.className = "px-2 py-1 rounded bg-white text-blue-600 shadow-sm transition-all";
                tabBulk.className = "px-2 py-1 rounded text-gray-500 hover:text-gray-700 transition-all";
            });

            tabBulk.addEventListener('click', (e) => {
                e.preventDefault();
                addPlayerForm.classList.add('hidden');
                bulkPlayerForm.classList.remove('hidden');
                tabBulk.className = "px-2 py-1 rounded bg-white text-blue-600 shadow-sm transition-all";
                tabSingle.className = "px-2 py-1 rounded text-gray-500 hover:text-gray-700 transition-all";
            });
            
            selectAllCheckbox.addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('.player-checkbox');
                checkboxes.forEach(cb => cb.checked = e.target.checked);
            });
            
            clearAllBtn.addEventListener('click', () => {
                if(confirm('Tem certeza que deseja apagar TODOS os jogadores? Isso n√£o pode ser desfeito.')) {
                    state.players = [];
                    savePlayersToDB();
                    renderPlayerList();
                }
            });

            addPlayerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addPlayer(
                    document.getElementById('name').value,
                    document.getElementById('fisico').value,
                    document.getElementById('habilidade').value,
                    document.getElementById('defesa').value
                );
                addPlayerForm.reset();
                document.getElementById('name').focus();
            });

            bulkPlayerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const text = document.getElementById('bulk-input').value;
                if (!text.trim()) return;
                const lines = text.split('\n');
                let count = 0;

                lines.forEach(line => {
                    if (!line.trim()) return;
                    const parts = line.split(/[;,]/).map(p => p.trim());
                    if (parts.length >= 2) {
                         const name = parts[0];
                         const val1 = parseFloat(parts[1]);
                         if (name && !isNaN(val1)) {
                             let f=val1, h=val1, d=val1;
                             if (parts.length >= 4) { f=parseFloat(parts[1]); h=parseFloat(parts[2]); d=parseFloat(parts[3]); }
                             if (!isNaN(f) && !isNaN(h) && !isNaN(d)) {
                                 state.players.push({
                                    id: crypto.randomUUID(), name,
                                    attributes: { fisico:Math.min(10,Math.max(0,f)), habilidade:Math.min(10,Math.max(0,h)), defesa:Math.min(10,Math.max(0,d)) }
                                });
                                count++;
                             }
                         }
                    }
                });
                if (count > 0) {
                    savePlayersToDB(); renderPlayerList();
                    document.getElementById('bulk-input').value = '';
                    alert(`${count} jogadores importados!`);
                } else {
                    alert('Formato inv√°lido. Use: Nome, Nota');
                }
            });

            playerList.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (btn && btn.dataset.deleteId) {
                    if (confirm('Excluir jogador?')) deletePlayer(btn.dataset.deleteId);
                }
            });

            drawTeamsForm.addEventListener('submit', handleDrawTeams);
            reshuffleBtn.addEventListener('click', (e) => handleDrawTeams(e));
            closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', (e) => { if (e.target.id === 'results-modal') modal.classList.add('hidden'); });

            loadPlayersFromDB();
            renderPlayerList();
        });
    </script>
</body>
</html>